# æ­å»ºè‡ªå·±çš„ Uniswapï¼šå®šä»·å’Œäº¤æ˜“

ä¸Šä¸€èŠ‚æˆ‘ä»¬ä¸ºPoolåˆçº¦æ·»åŠ æµåŠ¨æ€§ç®¡ç†çš„å‡½æ•°ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†å®ç°å®ƒçš„å®šä»·å’Œäº¤æ˜“åŠŸèƒ½ã€‚

## å®ç°å®šä»·åŠŸèƒ½

ä¼ ç»Ÿçš„è®¢å•ç°¿æœºåˆ¶äº¤æ˜“æ‰€ï¼Œäº¤æ˜“åŒæ–¹ä¼šæŠ¥ä»·ï¼Œç„¶åé å¹³å°æ’®åˆè®¢å•ï¼›ä¹Ÿå°±æ˜¯è¯´ä»·æ ¼æ˜¯ç”±äº¤æ˜“è€…æŠ¥ä»·äº§ç”Ÿï¼Œç„¶è€Œ AMM ä¸å­˜åœ¨ç±»ä¼¼çš„æŠ¥ä»·æœºåˆ¶ï¼Œå…¶ä»·æ ¼æ˜¯ç”±å…¬å¼å†³å®šï¼Œå³æ’å®šä¹˜ç§¯å…¬å¼ `x*y=k`ã€‚

æ¯ä¸€ç¬”äº¤æ˜“éƒ½ä¼šæ”¹å˜ä¸¤ä¸ªä»£å¸çš„æ•°é‡ï¼Œæ— è®ºæ•°é‡å¦‚ä½•å˜åŒ–ï¼Œ`k` éƒ½åº”è¯¥ä¿æŒä¸å˜ã€‚å½“ç”¨æˆ·å¸Œæœ›ç”¨èµ„äº§ x äº¤æ¢èµ„äº§ yï¼Œåˆ™ï¼š

$$(x + \Delta x)(y - \Delta y) = xy = k$$

é‚£ä¹ˆæ ¹æ®è¿™ä¸ªå…¬å¼ï¼Œæˆ‘ä»¬å°±èƒ½æ ¹æ®äº¤æ˜“çš„è¾“å…¥è®¡ç®—è¾“å‡ºçš„æ•°é‡ï¼Œæˆ–è€…åè¿‡æ¥ä¹Ÿä¸€æ ·ã€‚

è€Œ $\Delta x$ ä¸ $\Delta y$ çš„æ¯”å€¼å°±æ˜¯ä¼ ç»Ÿäº¤æ˜“çš„äº¤æ˜“ä»·æ ¼(äº¤æ˜“å‡ä»·)ï¼Œåªä¸è¿‡å¯¹äºæˆ‘ä»¬çš„åˆçº¦æ¥è¯´ï¼Œæˆ‘ä»¬ä¸éœ€è¦è®¡ç®—ä»·æ ¼ï¼Œåªéœ€è¦æä¾›ä¸€ä¸ªè®¡ç®—è¾“å…¥æˆ–è€…è¾“å‡ºæ•°é‡çš„æ–¹æ³•å³å¯ã€‚

### swap fees (äº¤æ˜“æ‰‹ç»­è´¹)

ä¼ ç»Ÿäº¤æ˜“æ‰€åœ¨è¾“å…¥èµ„äº§æ•°é‡ä¸­æ‰£é™¤æ‰‹ç»­è´¹ï¼Œæ¯”å¦‚è´¹ç‡ 1%ï¼Œ é‚£ä¹ˆäº¤æ˜“è€…ç”¨100ä¸ªèµ„äº§xä¹°å…¥èµ„äº§yï¼Œä¼šå…ˆæ‰£é™¤ 1 ä¸ªèµ„äº§xï¼Œç„¶åç”¨å‰©ä¸‹çš„èµ„äº§xäº¤æ˜“èµ„äº§yã€‚è€Œ AMM ä¸­é€šå¸¸åœ¨äº¤æ˜“è¾“å‡ºç«¯æ”¶è´¹ï¼Œå³åœ¨èµ„äº§yæ•°é‡çš„åŸºç¡€ä¸Šæ‰£é™¤ 1%ã€‚

æ‰€ä»¥æ ¹æ®å…¬å¼è®¡ç®—å‡ºçš„è¾“å‡ºç«¯æ•°é‡ä¹‹åï¼Œè¿˜è¦æ‰£é™¤è¿™ 1% æ‰‹ç»­è´¹ä½œä¸º LP çš„æ”¶ç›Šï¼Œç•™åœ¨ Pool åˆçº¦ä¸­ã€‚

### LP çš„æ”¶ç›Š

LP è´¡çŒ®äº†äº¤æ˜“çš„æµåŠ¨æ€§ï¼Œé‚£ä¹ˆäº¤æ˜“æ‰‹ç»­è´¹å³æ˜¯ä»–ä»¬çš„æ”¶ç›Šã€‚å‡è®¾ Pool ä¸­åŸæœ¬ç”±ä»·å€¼ 1000 USDC çš„èµ„äº§ä½œä¸ºæµåŠ¨æ€§ï¼Œç»è¿‡ä¸€æ®µæ—¶é—´äº¤æ˜“åï¼Œé€šè¿‡æ‰‹ç»­è´¹å¢åŠ äº† 10 USDC ä»·å€¼çš„èµ„äº§ï¼Œç›®å‰ Pool çš„æ€»æµåŠ¨æ€§ä»·å€¼ 1010 USDCï¼Œ äºæ˜¯å½“ LP èµå›æµåŠ¨æ€§æ—¶ï¼Œä¼šæŒ‰ç…§æ¯”ä¾‹åˆ†é…è¿™å¤šå‡ºæ¥çš„åˆ©æ¶¦ï¼Œå³ä¸ºLPçš„æ”¶ç›Šã€‚

### `getAmount`

æˆ‘ä»¬å®šä¹‰ä¸€ä¸ª `getAmount` å‡½æ•°ç”¨æ¥è®¡ç®—äº¤æ˜“åï¼Œ Pool èµ„äº§çš„æ•°é‡ã€‚æ¯”å¦‚å½“ç”¨èµ„äº§ x äº¤æ˜“ y ï¼ˆå·²çŸ¥xæ•°é‡ï¼Œæ±‚yçš„æ•°é‡ï¼‰ï¼Œé‚£ä¹ˆ `getAmount` å‡½æ•°å°†è®¡ç®—å‡ºäº¤æ˜“ä¹‹åï¼ŒPoolä¸­yèµ„äº§çš„æ•°é‡ï¼ˆå‡å°‘åï¼‰ã€‚

$$
(y - \Delta y) = xy / (x + \Delta x)
$$

> ç”±äº solidity ä¸æ”¯æŒæµ®ç‚¹è¿ç®—ï¼Œè®¡ç®—ç™¾åˆ†æ¯”æ—¶å¯ä»¥åˆ†å­ä¹˜ä»¥ 99ï¼Œ åˆ†æ¯ä¹˜ä»¥100.

```solidity
// This is a low-level function, so let it be private.
function getAmount(
    uint256 inputAmount,
    uint256 inputReserve,
    uint256 outputReserve
) private pure returns (uint256) {
    // æ£€æŸ¥ `inputReserve` å’Œ `outputReserve` éƒ½å¿…é¡»å¤§äº0ï¼Œå¦åˆ™æŠ¥é”™ "invalid reserves"

    // æ”¶å–1%çš„æ‰‹ç»­è´¹
    // solidity ä¸æ”¯æŒæµ®ç‚¹è¿ç®—ï¼Œæ‰€ä»¥åˆ†å­å’Œåˆ†æ¯åŒæ—¶ Ã— 100
    // outputAmount = (inputAmount * outputReserve) / (inputReserve + inputAmount) 

    // è¿”å›ç»“æœ
}
```

åœ¨å®ç°äº†å†…éƒ¨è®¡ç®—å‡½æ•°ä¹‹åï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸ªå‡½æ•°åˆ†åˆ«ä¸ºäº¤æ˜“ ETH å’Œäº¤æ˜“ Token æš´éœ²ä¸¤ä¸ªæŸ¥è¯¢æ¥å£ï¼š

```solidity
// å·²çŸ¥è¾“å…¥ç«¯ ETH çš„æ•°é‡ï¼ŒæŸ¥è¯¢è¾“å‡ºç«¯ Token æ•°é‡
function getTokenAmount(uint256 amount) public view returns (uint256) {
    // æ£€æŸ¥ amount å¤§äº0ï¼Œå¦åˆ™æŠ¥é”™ "amount is too small"

    // è·å– Pool åˆçº¦ Token çš„æ•°é‡

    // åˆ©ç”¨ `getAmount` å†…éƒ¨è®¡ç®—å‡½æ•°è®¡ç®—ç»“æœï¼Œå¹¶è¿”å›
}

// å·²çŸ¥è¾“å…¥ç«¯ Token çš„æ•°é‡ï¼ŒæŸ¥è¯¢è¾“å‡ºç«¯ ETH æ•°é‡
function getEthAmount(uint256 amount) public view returns (uint256) {
    // æ£€æŸ¥ amount å¤§äº0ï¼Œå¦åˆ™æŠ¥é”™ "amount is too small"

    // è·å– Pool åˆçº¦ Token çš„æ•°é‡

    // åˆ©ç”¨ `getAmount` å†…éƒ¨è®¡ç®—å‡½æ•°è®¡ç®—ç»“æœï¼Œå¹¶è¿”å›
}
```

## swap (äº¤æ˜“åŠŸèƒ½)

äº¤æ˜“åŠŸèƒ½éœ€è¦åŒºåˆ†äº¤æ˜“æ–¹å‘ï¼Œæˆ‘ä»¬ä½¿ç”¨ `bool ETHForToken` ä½œä¸ºæ ‡è¯†ã€‚

å¹¶ä¸”ä¸ºäº†é˜²æ­¢äº¤æ˜“è¢«æŠ¢è·‘æ”»å‡» ([front-runing attack](https://quillaudits.medium.com/front-running-and-sandwich-attack-explained-quillaudits-de1e8ff3356d)), æˆ‘ä»¬éœ€è¦å¢åŠ ä¸€ä¸ªæœ€å°äº¤æ˜“è¾“å‡ºé‡çš„å‚æ•°ã€‚

å¦å¤–ï¼Œè¿˜å¯ä»¥å¢åŠ ä¸€ä¸ª `recipient` å‚æ•°ï¼Œè®©äº¤æ˜“è¾“å‡ºçš„èµ„äº§å¯ä»¥æŒ‡å®šä¸åŒçš„æ¥å—åœ°å€ï¼Œè¿™ä¸ªåŠŸèƒ½åœ¨åç»­ token äº¤æ˜“ token çš„æµç¨‹ä¸­ä¼šç”¨åˆ°ã€‚

```solidity
function swap(
    uint256 amountIn,
    uint256 minAmountOut,
    bool ETHForToken,
    address recipient
) public payable returns (uint256 amountOut) {
    // ETH in Token out
    if (ETHForToken) {
        // è·å–äº¤æ˜“ä¹‹å‰çš„ä¸¤ç§èµ„äº§çš„æ•°é‡ï¼Œè¿™é‡Œæ³¨æ„ï¼ŒETHæ•°é‡éœ€è¦æ‰£é™¤ `msg.value`

        // ä½¿ç”¨ `getAmount` å‡½æ•°è®¡ç®—äº¤æ˜“è¾“å‡ºæ•°é‡

        // æ£€æŸ¥ `amountOut` ä¸ä½äº `minAmountOut`, å¦åˆ™æŠ¥é”™ "insufficient output amount"

        // å°†äº¤æ˜“è¾“å‡ºçš„ token è½¬ç»™ `recipient`
    } else {
        // Token in ETH out
       // è·å–äº¤æ˜“ä¹‹å‰çš„ä¸¤ç§èµ„äº§çš„æ•°é‡ï¼Œè¿™é‡Œæ³¨æ„ï¼ŒETHæ•°é‡éœ€è¦æ‰£é™¤ `msg.value`

        // ä½¿ç”¨ `getAmount` å‡½æ•°è®¡ç®—äº¤æ˜“è¾“å‡ºæ•°é‡

        // æ£€æŸ¥ `amountOut` ä¸ä½äº `minAmountOut`, å¦åˆ™æŠ¥é”™ "insufficient output amount"
        
        // ä½¿ç”¨ `ERC20.transferFrom` å°†ç”¨æˆ·çš„ Token è½¬å…¥
        // å°†äº¤æ˜“è¾“å‡ºçš„ ETH è½¬ç»™ `recipient`
    }
}
```

## ğŸ ç›®æ ‡

Pool ä»·æ ¼æŸ¥è¯¢ä»¥åŠäº¤æ˜“çš„åŠŸèƒ½ï¼›

ä¸ºå…¶æ·»åŠ ä»¥ä¸‹å‡½æ•°ï¼š

- `getAmount`: äº¤æ˜“æ•°é‡æŸ¥è¯¢çš„å†…éƒ¨å‡½æ•°
- `getTokenAmount`: å·²çŸ¥è¾“å…¥ç«¯ ETH çš„æ•°é‡ï¼ŒæŸ¥è¯¢è¾“å‡ºç«¯ Token æ•°é‡
- `getEthAmount`: å·²çŸ¥è¾“å…¥ç«¯ Token çš„æ•°é‡ï¼ŒæŸ¥è¯¢è¾“å‡ºç«¯ ETH æ•°é‡
- `swap`: æ‰§è¡Œäº¤æ˜“
